1. visualizer_scroll.py
베지에 곡선을 시뮬레이션 할 수 있는 소스코드 입니다.

<라이브러리 설치>

pip install numpy matplotlib

visualizer.py 은 메소드 내부에 각도와 좌표를 지정하여 베지에 곡선을 그리는 방식이다.

visualizer_scroll.py 은 이를 개선하여 스크롤로 좌표들을 조정할 수 있게 만든 버전이다.





✅ 1. 시작점과 끝점의 방향(각도) 고정 및 조정 가능
P0의 방향(θ₀)을 슬라이더로 실시간 조정할 수 있으며,

P3의 방향은 고정되어 있어 끝점의 방향 조건이 명확한 제약 조건으로 작동합니다.

이는 실제 로봇 경로 생성, 곡선 연결, 인터폴레이션 등에서 자주 필요한 제약 조건입니다.

✅ 2. 거리(d₀, d₁)를 직관적으로 조절 가능
슬라이더를 통해 제어점과의 거리(d0, d1)를 조정함으로써 곡선의 굴곡(곡률)을 실시간 제어할 수 있습니다.

이 접근 방식은 곡률을 조정할 때 수치적으로 안정적이며 직관적입니다.

✅ 3. 제어점 드래그 기능으로 곡선 형상 직접 수정 가능
P1, P2 제어점을 마우스로 직접 드래그하여 위치 조절이 가능하며, 이 동작은 d0, d1을 업데이트하여 일관된 방향 벡터를 유지합니다.

따라서 위치 조절과 방향 조건의 연동을 유지한 채로 직관적인 수정이 가능합니다.

✅ 4. 슬라이더로 시작점 P0도 조절 가능
P0의 위치를 슬라이더로 조정하면, 시작 각도 theta0과 거리 d0에 따라 자동으로 P1이 재계산되어, 전체 곡선의 시작점 조건을 유지하며 움직임을 시뮬레이션할 수 있습니다.

✅ 5. 구현 구조가 명확하고 확장 가능
DraggableControlPoints 클래스를 중심으로, 데이터(제어점, 각도, 거리)와 동작(업데이트, 드래그, 슬라이더 연동)이 잘 분리되어 있어:

다양한 조건 제약을 추가하기 쉽고,

향후 3차원 곡선이나 다중 곡선 연결 등으로 확장하기도 유리합니다.

✅ 6. 시각적 피드백이 빠르고 직관적
각 제어점의 이름, 방향 벡터(화살표), 색상 등을 다르게 설정하여 사용자가 구조를 쉽게 이해할 수 있도록 시각적 단서를 제공합니다.

실시간 draw_idle()을 통해 빠른 피드백이 제공됩니다.

💡 요약
이 코드는 **곡선의 시작 조건(위치 + 방향)**과 **끝 조건(위치 + 방향)**을 유지하면서도 곡선의 형태를 다양한 방식으로 직관적이고 실시간으로 조정할 수 있게 하여, 인터랙티브한 곡선 설계 도구로 매우 유용합니다.

![image](https://github.com/user-attachments/assets/c4ee03e4-7cea-4060-82d7-166c463a0971)


2. park.py
해당 대회의 misson_2에서 사용할 메인 소스코드 입니다.

<라이브러리 설치>
pip install apriltag
pip install scipy
pip install opencv-python
pip install matplotlib
pip install numpy	


해당 코드에 대한 설명 입니다. (약간의 사족을 붙인)
✅ 코드 사용의 장점
1. 실시간 태그 검출 및 시각화
카메라 프레임에서 AprilTag를 검출하고, 검출된 태그를 실시간으로 시각화하여 디버깅이 매우 쉬움.

사각형 윤곽선과 중심좌표 표시로, 태그가 정확히 인식되는지 여부를 바로 확인 가능.

2. 3D 위치 추정
detector.detection_pose()를 사용하여, 태그의 공간상의 위치(거리 및 방향) 정보를 정밀하게 계산 가능.

자동차 기준으로 태그가 얼마나 떨어져 있고, 어느 방향에 있는지를 정확히 파악할 수 있음.

3. 회전 정보 추출 (Yaw)
회전 행렬을 오일러 각(zyx 순서)으로 변환하여, Yaw (Y축 회전) 을 도 단위로 추출.

자율주행 차량이 태그를 정면으로 바라보고 있는지, 어느 정도 각도로 비틀어져 있는지를 정량적으로 판단 가능.

4. ROS 기반 통신 구조 완비
rospy.init_node, Subscriber, Publisher 구성 완비 → 실제 자율주행 플랫폼에 바로 적용 가능.

/usb_cam/image_raw로부터 이미지를 받고, /xycar_motor로 모터 제어를 수행하는 구조가 표준화되어 있음.

5. 직관적이고 명확한 코드 구성
시각화, 좌표 추출, 거리계산, 회전 추출 등 각 역할이 명확하게 나누어져 있어 유지보수 및 확장 용이.

ROS 메시지 처리 흐름과 OpenCV 사용법이 깔끔하게 정리되어 있음.

✅ 시각 출력 정리
출력 항목	내용	이미지에서의 위치
태그 윤곽선	초록색 사각형	태그 외곽선
중심 좌표	"center:(x,y)" 텍스트	태그 중심 위치에 출력
거리	Distance: x.xx m	콘솔 출력
위치	Position (x, y, z): [...]	콘솔 출력
Yaw 각도	Y축(Yaw): xx.xx°	콘솔 출력

✅ 응용 가능성
이 코드를 바탕으로 다음과 같은 기능으로 확장 가능:

🧭 태그 방향에 따라 조향각 조절

yaw 값을 이용하여 차량이 태그 방향으로 자동 조향 가능

🚦 태그 인식 후 정지, 회전 등 제어 전략 추가

특정 ID의 태그 인식 시 이벤트 수행 (예: 정지, U턴 등)

🧠 태그 기반 위치 인식 및 맵핑

여러 개의 태그로부터 위치 추정하여 SLAM에 활용 가능

![image](https://github.com/user-attachments/assets/a9ef1333-28f4-4255-ba02-eb8e3f4ac6bb)


3. combine_test.py

visualizer.py 와 park.py 코드를 바탕으로 만든 초기에 시작점과 도착점 사이의 베지에 곡선을 계산하고 이를 추종하게 하는 알고리즘입니다.

코드 상에서 차트 창과 카메라 창은 서로 다른 스레드 상에서 돌아가고 차트 창의 베지에 곡선은 기본적으로 매번 다시 계산되어 갱신되기 때문에 무한 루프 상에서 작동하여 초기 베지에 곡선 정보로 고정시켰습니다.

베지에 곡선은 맨 처음 한번만 계산되어 띄워집니다.

일정 거리 미만이 되면 곡선을 재 계산하여 오차를 보정하는 알고리즘을 생각 중입니다.(구현x)

차트 상의 p0 좌표는 p3 초기좌표를 바탕으로 계산한 상대 좌표입니다. 이에 따른 오차가 발생합니다.

좌표 보정은 단순히 각도 고정 변화로만 이루어지기에 이에 대한 보완이 필요합니다.

초록 점은 현재 위치이고 노란 점은 가장 가까운 곡선 상의 위치입니다.

![image](https://github.com/user-attachments/assets/3ec849c1-3e63-454b-b190-e66ae44aa76c)

장점

✅ 1. 모듈화된 구성과 명확한 기능 분리
각 기능이 함수 단위로 잘 나누어져 있어 유지보수 및 확장이 쉬움:

usbcam_callback: 이미지 수신 처리

drive: 모터 제어

bezier_visualization_loop: 베지에 곡선 기반 경로 시각화

start: 전체 프로그램 로직 수행

✅ 2. AprilTag 기반 실시간 위치 및 자세 추정
apriltag을 활용하여 태그의 상대 위치(pose) 및 yaw 회전각을 추정함.

검출된 AprilTag로부터 차량의 위치와 방향을 계산할 수 있어 정밀한 주행이 가능함.

자세한 출력 (좌표, 거리, yaw)을 통해 디버깅 및 튜닝이 용이.

✅ 3. 베지에 곡선을 활용한 경로 생성 및 방향 결정
태그까지의 경로를 베지에 곡선으로 생성해 자연스러운 경로 추종 가능.

종단점의 yaw 정보를 활용해 진행 방향을 예측.

closest_point를 기준으로 차량의 좌/우 회전을 단순하게나마 제어함.

✅ 4. Matplotlib 시각화를 통한 디버깅 지원
실시간 베지에 경로, 위치, yaw 방향을 시각적으로 확인할 수 있어 경로설계 및 조향 판단 디버깅에 유용.

plt.ion()을 활용한 비차단형 시각화 루프를 별도 스레드에서 실행하여 ROS 루프와 병행 가능.

✅ 5. ROS 기반 아키텍처
rospy, sensor_msgs, xycar_msgs, cv_bridge 등을 활용해 ROS 환경에 통합.

이미지 및 모터 제어가 ROS 토픽을 통해 작동되어 실제 차량 환경과 잘 연결됨.

rospy.wait_for_message() 등으로 시스템 안정성 확보.

✅ 6. 비동기 처리를 위한 스레드 도입
경로 시각화는 메인 주행 루프와 별개로 실행되며, 이는 시각화로 인한 지연을 방지함.

✅ 7. 코드 가독성과 주석 정리
대부분의 함수와 주요 로직에 상세한 주석이 포함되어 있어 타인이 읽기 쉽고, 학습에도 적합.

✅ 8. 태그 중심 조향 제어의 간편한 구현
가장 가까운 곡선 포인트와 현재 위치를 비교해 간단한 조향 제어(angle ±50) 구조로 구현.

향후 PID, Pure Pursuit 등으로 확장하기에도 적합한 기본 틀 제공.

문제점
❌ 1. 조향 제어 알고리즘이 단순함


❌ 2. 베지에 곡선이 매 주기 갱신되지 않음
bezier_visualization_loop에서는 곡선을 한 번만 계산하고, 이후에는 업데이트하지 않음:


❌ 3. AprilTag에만 의존한 위치 추정
경로 설정이 전적으로 AprilTag에만 의존함.


❌ 4. 태그 인식 실패 시 예외 처리 없음


❌ 5. P3 기준 방향 벡터 오류 가능성


❌ 6. 현재 위치 계산 방식이 부정확

❌ 7. 속도 고정 (speed = 5 or Fix_Speed)
모든 상황에서 속도가 고정되어 있음.

급격한 조향, 가까운 거리 등에서도 동일한 속도를 유지 → 과속 또는 불안정 주행 가능.


❌ 8. 멀티태그 고려 안됨

